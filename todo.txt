
Release 8:

Changelog:

UI:
 * Added a new component for side information (shows active general, active tactic and dice roll).
 * Moved randomize dice checkbox and input for rng seed under dice extra settings (plus icon).
 * Moved morale and discipline inputs from army information component to unit information component.
 * EUIV: Moved culture selection to unit information component.
 * EUIV: Moved Backrow efficiency to army information component.
 * Fixed terrain selector not showing the selection.
 * Win rate now also includes draws and incomplete battles (so the total should always be 100%), the tooltip still separates them.
 * Win rate tooltip now also shows how many battles were done.
 * Added losses (from Analyze) to the main page (similar to win rate but shows percentage of strength lost).
 * Losses tooltip also shows raw amount of strength lost, chance to lose less strength than the enemy and compare how much more/less strength was lost.
 * Analyze settings moved from Settings page to Analyze page (no need to move between pages when tweaking things).
 * Going backwards in battle is now much faster (previously recalculated whole battle).
 * Unit tooltips now show the round of defeated for defeated units.
 * Removed ability to manually add units to frontline or defeated. Multiple armies can be used if you need to micro the deployment.
 * Selections on Countries page are now more darker (better visibility).

Refactor
 * Side and participant separated. Side now contains multiple participants.
 * All variable names renamed to have same casing.
 * Cohort id system redesigned. Units now get ids based on their index instead of a running number. This makes code much cleaner and unit searching much faster.

Analyze
 * Phase length multiplier setting changed to phases per roll setting. The effect is similar but also works with EUIV fire and shock phases.
 * Preset performance setting updated to work with the new setting (EUIV works now much faster).
 * Max rounds for each preset changed to 30. This should be more than enough for full combat width battles.

Combat
 * Removed round number -1 (predeployment). This makes the simulator easier to use because units instantly appear on the screen.
 * Added support for multiple separate battles.
 * If one side runs out of units then the battle ends. Losers deployed armies are removed and stack wiping checked.
 * If the losing side still has undeployed armies a new battle starts when an army arrives.
 * Fixed border terrain affecting both sides.

Todo: 

Data:
 * IR units have mode (should be derived from base)

Needed tests:
 * Guide lines:
  - Tests with in-game are fairly useless? Testing different mechanics would verify that combat formula is accurate but is it worth it?
  - Tests should verify that the code works as intended, not that the result matches in game. Matching must be done manually anyways if the game changes.
  - Custom unit types with neutral values by default.
 * Tests:
  - Precision. In-game test with many rounds to verify that calculation accuracy matches the game.
  - Different mechanics, no in-game comparison required since all are just damage modifiers.
* Deployment
  - Many scenarios
  - Late deployment (with and without penalty)
* Reinforcement
  - Non-secondary penalty
  - Better general changing order
  - 
* Mechanics
  - Flank ratio


Multiarmy:
 - Test:
  * Late deploy / reinforcement penalties
  * !!! Attacker may become defender (if defender loses but has reinforcements), affects terrain bonus, defenders' advantage, UI?
  * Stack wiping should only affect cohorts defeated in current battle (another list for afterfight defeated? or track defeated round (to determine if part of current battle))
  * Stack wipes during battle (cohorts run out before reinforcements arrive)
  * Leading general (especially when cohorts run out during battle): dealt damage, deployment
  * Multiarmy deployment, redeployment after cohortsr run out (fresh units prioritized)
  * Big stackwipes (defeated and reserve get stackwiped properly too)
  * !!Combat phases also have to reset (be based on duration, probably have to store previous phase number so that dice rolls don't repeat from start)

 - Battle has two sides and terrain.
 - Each side includes dice (+ related things), N participants and rounds list.
 - Each participant includes country, army and days until battle.
 - CombatSide also includes active tactic and active general martial.

 - UI needs component for side: For dice and showing active martial / tactic (with damage effect).
 - UI needs a table for participants (with a way to add and delete).
 - Quick selectors need a redesign. They currently work only for one army. Still show components for both attacker and defender? But with an army selector?

 - Deployment needs rework. Need to first figure out how units from multiple armies are pooled.
 - Must also work with battle possibly restarting times (stack wipes!).

 - Army joining battle triggers deploy (without secondary penalty), remaining units get pooled together.
 - Currently pooling is done first, so can't detect reinforcement from late deploy. Units should know the turn they arrive?
  * If unit deploys during first phase and when it arrives, no penalty.
  * If unit deploys as reinforcement and after retreat, no penalty if secondary.
  * If unit deploys instantly but late, late penalty.
  * Pooled reinforcements use the leading generals settings, instant deploys current generals settings. So unit would need to know its general...
 - Needs different logic -> when army joins -> sort reserve -> deploy with its settings -> then merge to common reserve -> at end sort reserve.

Test:
 - Targeting (strength based flank, weak targets)
 - Check that reinforcement is stable (higher key ends in right position)

UI:
 - Togglable stats rows to show individual units or hide unit types.
 - Unit tooltip should somehow show sources for losses (to include daily loss from EUIV and damage from different units).
 - Unit type selector should automatically upgrade/downgrade selected unit to a similar unit. Up to 4 choices but with no clear typing. Also remove Latest. + Setting for this.
  * Sometimes units have same offensive/defensive allocation but focuses on different attribute. Sometimes same attribute allocation but different offensive/defensive focus.
  * Seems mostly a problem for Western with so many unit types.
  * One heuristic could be: Count offensive and defensive pips of all stats, and then count offensive/defensive for two biggest stats as tiebreaker.
  * When selecting unit store its primary and secondary type as the selection. When upgrading/downgrading use these types to select the unit.

Countries:
 - Inventions to show tag specific (without actually implementing tags).
  * These inventions are extra. Perhaps a 4th slot for toggle? Or just implement scrolling?

Land battle:
- Deployment order based also on manpower!! (before index), need to to test whether full strength is prioritized for both deploy and reinforce


Release++:

Settings:
 - discipline: Reduces damage, only increases damage, no effect.
 - general maneuver: Affects crossing, affects terrain, affects both, no effect.
 - general: martial, fire&shock, both
 - Show on main page current settings set (Imperator, EUIV, mixed), tooltip to show individual (or only changed?)
 - New settings for deployment / reinforcement order/attribute.
 - Settings from hardcoded.txt with auto generation.

Todo:
 - Transfer could only show non-base stats for units, terrains and tactics (since base stats are supposed to regenerate?), currently it shows way too much information.
 - Refactor simluation to update only single parameter, also parameters split should make more sense
 - Rowtype selectors could show unit priority? Different colors for main and flank. Frontline could slightly color tiles based on main/flank.
 - Stats to show amount of traditions, trade, etc..
 - Definition functions probably all could mutate (mostly used in reducers?)
 - Analyze could automatically set precision based on unit count (or some other heuristic like timing first batch).
 - Analyze width compress:
  * Deploy, check that all units have same type, fight one round, check that all units have same strength/morale -> can be simulated 1v1.
  * Do above until units run out -> Amount of possible 1v1.
  * Improves performance up to 30x.
  * Similar thing could also be done for left and right side (but only 2x performance and flanking/movement needs special implementation.
 - Save import to load battles and automatically import participants (sets those armies active and sets correct round value).
 - A button for random setup
 - Stackwipe capturing probably doesn't work for analyze
 - Combat reducer without immer? Need to solve the mess anyways.

Tests:
- utils tested

Tags:
 - Icons to frontline to show various things, with tooltips:
  * Defender's advantage (some kind of ninja icon?) - Needed for EUIV.
  * Very bad matchup, bad match up, good matchup, very good matchup (red or green arrows)
  * Flanking (attacking without being attacked)
  * No target (red sign)
 - Battle stats to show amount of tags acquired (hopefully gives a better view of the battle)

Combat calculations:
- In the game, integer calculations are used so the result is rounded down after each step.
- This doesn't matter in Imperator because of higher precision but causes manpower to be bit off in EUIV.
- Implementing this slows down the combat a lot because precalculation won't be possible.
- Also the exact order of calculations must be researched or acquired from devs to get accurate results.